{% load tailwind_cli %}
<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Room</title>
  {% tailwind_css %}
  <link rel="stylesheet" href="{% static 'css/chat_room.css' %}?v={% now 'U' %}">
</head>

<body>
  {% include "navbar.html" %}

  <!-- Grid Layout -->
  <div class="chat-layout">

    <!-- LEFT SIDEBAR -->
    <aside id="left-sidebar" class="chat-sidebar">
      <div class="sidebar-header">
        <h2 class="sidebar-title">Direct Messages</h2>
        <ul class="sidebar-list">
          {% for dm in dm_list %}
            <li>
              <a href="{% url 'direct_message' dm.id %}" 
                 class="sidebar-link">{{ dm.other_user.username }}</a>
            </li>
          {% empty %}
            <p class="empty-text">No direct messages yet.</p>
          {% endfor %}
        </ul>

        <h2 class="sidebar-title" style="margin-top: 24px;">Groups</h2>
        <ul class="sidebar-list">
          {% for group in groups %}
            <li>
              <a href="{% url 'chat_room' group.slug %}"
                 class="sidebar-link">{{ group.name }}</a>
            </li>
          {% empty %}
            <p class="empty-text">You're not part of any groups yet.</p>
          {% endfor %}
        </ul>
      </div>
    </aside>

    <!-- CHAT SECTION -->
    <main class="chat-main">
      <div id="chat-log" class="chat-log">
        {% for message in messages %}
          <div class="message-bubble {% if message.sender.username == user.username %}message-self{% else %}message-other{% endif %}">
            <span class="message-sender">{{ message.sender.username }}:</span> {{ message.content }}
            {% if message.image %}
              <br><img src="{{ message.image }}" alt="Image" class="message-image">
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <!-- Image Preview & Input -->
      <div class="chat-input-area">
        <div id="image-preview" class="image-preview-container hidden">
            <img id="preview-img" class="preview-img" alt="Preview">
            <button id="remove-image-btn" class="remove-img-btn">Remove</button>
        </div>

        <div class="input-container">
          <input id="chat-message-input"
            class="chat-input"
            type="text" placeholder="Type your message..." />
          <input id="image-input" type="file" accept="image/*" style="display:none;" />

          <button id="image-upload-btn" class="icon-btn">
              +
          </button>

          <button id="chat-message-submit" class="send-btn">Send</button>
        </div>
      </div>
    </main>

    <!-- RIGHT SIDEBAR -->
    <aside id="right-sidebar" class="chat-sidebar">
      <div class="sidebar-header">
        {% if thread %}
          <h2 class="sidebar-title">Direct Message</h2>
          <p class="sidebar-subtitle">Chatting with <span style="font-weight: 600; color: #1F2937;">{{ other_user.username }}</span></p>
        {% else %}
          <h2 class="sidebar-title">Room: {{ room_name }}</h2>
          <p class="sidebar-subtitle">Room Code: {{ room_code }}</p>
        {% endif %}
      </div>

      {% if members %}
      <div class="sidebar-header">
        <h3 class="sidebar-title" style="font-size: 1rem;">Members</h3>
        <ul class="sidebar-list">
          {% for member in members %}
            <li>
              <span class="sidebar-link">{{ member.username }}</span>
            </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Display Persistent Notifications -->
      <div class="sidebar-header" style="border-bottom: none;">
        <h3 class="sidebar-title" style="font-size: 1rem;">Notifications</h3>
        <div id="notification-list">
          {% if notifications %}
            {% for notification in notifications %}
              <div class="notification-item">
                <p class="notification-text">{{ notification.message }}</p>
                <p class="notification-time">{{ notification.created_at|date:"H:i" }}</p>
              </div>
            {% empty %}
              <p class="empty-text">No new notifications</p>
            {% endfor %}
          {% else %}
            <p class="empty-text">No notifications</p>
          {% endif %}
        </div>
      </div>

      <!-- Badge for unread count -->
      <div id="notification-badge" class="notification-badge hidden">
        <span id="badge-count">0</span>
      </div>
    </aside>

    <!-- FLOATING TOGGLE BUTTONS -->
    <button id="toggle-left" class="toggle-btn toggle-left">
      ⮜
    </button>

    <button id="toggle-right" class="toggle-btn toggle-right">
      ⮞
    </button>
  </div>

  <!-- WebSocket Script -->
  <script>
    const roomName = "{{ room_name }}";
    const username = "{{ user.username }}";

    {% if thread %}
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/dm/' + '{{ thread.id }}' + '/');
    {% else %}
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');
    {% endif %}

    const chatLog = document.querySelector('#chat-log');
    let selectedImage = null;
    let isTyping = false;
    let unreadNotifications = [];

    window.onload = () => chatLog.scrollTop = chatLog.scrollHeight;

    // load notifications on page load
    window.addEventListener('load', () => {
      const notifications = document.querySelectorAll('#notification-list > div');
      updateNotificationBadge(notifications.length);
      
      // Initialize sidebar state
      updateSidebars();
    });

    function updateNotificationBadge(count) {
      const badge = document.getElementById('notification-badge');
      const badgeCount = document.getElementById('badge-count');

      if (count > 0) {
          badgeCount.textContent = count;
          badge.classList.remove('hidden');
      } else {
          badge.classList.add('hidden');
      }
    }

    // Image Upload Button
    document.getElementById('image-upload-btn').addEventListener('click', () => {
        document.getElementById('image-input').click();
    });

    // File Input Change
    document.getElementById('image-input').addEventListener('change', (e) => {
        selectedImage = e.target.files[0];
        if (selectedImage) {
            showImagePreview(selectedImage);
            console.log("Image selected:", selectedImage.name);
        }
    });

    // Paste Image
    document.getElementById('chat-message-input').addEventListener('paste', (e) => {
        const items = e.clipboardData.items;

        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                e.preventDefault();
                selectedImage = item.getAsFile();
                showImagePreview(selectedImage);
                console.log("Image pasted:", selectedImage.name);
                break;
            }
        }
    });

    // Show Image Preview
    function showImagePreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewDiv = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            previewImg.src = e.target.result;
            previewDiv.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    // Remove Image Button
    document.getElementById('remove-image-btn').addEventListener('click', () => {
        selectedImage = null;
        document.getElementById('image-preview').classList.add('hidden');
        document.getElementById('image-input').value = '';
    });

    // Handle Messages
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.type === 'message') {
            const messageDiv = document.createElement('div');
            const isSelf = data.username === username;
            messageDiv.className = `message-bubble ${
                isSelf ? 'message-self' : 'message-other'
            }`;
            messageDiv.innerHTML = `<span class='message-sender'>${data.username}:</span> ${data.message}`;

            if (data.image_url) {
                messageDiv.innerHTML += `<br><img src="${data.image_url}" alt="Image" class="message-image">`;
            }
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

            removeTypingIndicator(data.username);
        }

        if (data.type === 'notification' && data.username !== username) {
          const notificationList = document.getElementById('notification-list');
          const notificationDiv = document.createElement('div');
          notificationDiv.className = 'notification-item';
          const now = new Date();
          const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                          now.getMinutes().toString().padStart(2, '0');
          notificationDiv.innerHTML = `
            <p class="notification-text">${data.title}</p>
            <p class="notification-time">${timeStr}</p>
            `;
          notificationList.insertBefore(notificationDiv, notificationList.firstChild);

          const allNotifications = document.querySelectorAll('#notification-list > div');
          updateNotificationBadge(allNotifications.length);

        }

        if (data.type === 'typing_start') {
            showTypingIndicator(data.username);
        }

        if (data.type === 'typing_stop') {
            removeTypingIndicator(data.username);
        }
    };

    // Send Message
    document.querySelector('#chat-message-submit').onclick = function () {
        const input = document.querySelector('#chat-message-input');
        const msg = input.value.trim();

        if (!msg && !selectedImage) return;

        if (selectedImage) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageData = event.target.result;
                chatSocket.send(JSON.stringify({
                    type: 'message',
                    username: username,
                    message: msg,
                    image: imageData
                }));
                input.value = '';
                selectedImage = null;
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('image-input').value = '';
                isTyping = false;
            };
            reader.readAsDataURL(selectedImage);
        } else {
            chatSocket.send(JSON.stringify({
                type: 'message',
                username: username,
                message: msg
            }));
            input.value = '';
            isTyping = false;
        }
    };

    // Enter Key to Send
    document.querySelector('#chat-message-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') document.querySelector('#chat-message-submit').click();
    });

    // Sidebar Toggle Logic
    const leftSidebar = document.getElementById('left-sidebar');
    const rightSidebar = document.getElementById('right-sidebar');
    const toggleLeft = document.getElementById('toggle-left');
    const toggleRight = document.getElementById('toggle-right');

    // Check if mobile
    const isMobile = window.innerWidth < 768;

    let leftOpen = !isMobile; // Closed on mobile, open on desktop
    let rightOpen = !isMobile;

    function updateSidebars() {
        leftSidebar.style.width = leftOpen ? '16rem' : '0';
        rightSidebar.style.width = rightOpen ? '16rem' : '0';
        
        toggleLeft.innerText = leftOpen ? '⮜' : '⮞';
        toggleRight.innerText = rightOpen ? '⮞' : '⮜';
    }

    toggleLeft.addEventListener('click', () => {
        leftOpen = !leftOpen;
        if (isMobile && leftOpen) {
            rightOpen = false; // Close other sidebar on mobile
        }
        updateSidebars();
    });

    toggleRight.addEventListener('click', () => {
        rightOpen = !rightOpen;
        if (isMobile && rightOpen) {
            leftOpen = false; // Close other sidebar on mobile
        }
        updateSidebars();
    });

    // Typing Indicators
    function showTypingIndicator(user) {
        let indicator = document.getElementById(`typing-${user}`);
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = `typing-${user}`;
            indicator.className = 'text-gray-500 italic text-sm self-start';
            indicator.style.color = '#6B7280';
            indicator.style.fontStyle = 'italic';
            indicator.style.fontSize = '0.875rem';
            indicator.style.alignSelf = 'flex-start';
            indicator.textContent = `${user} is typing...`;
            chatLog.appendChild(indicator);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    }

    function removeTypingIndicator(user) {
        const indicator = document.getElementById(`typing-${user}`);
        if (indicator) {
            indicator.remove();
        }
    }

    const messageInput = document.querySelector('#chat-message-input');

    messageInput.addEventListener('input', () => {
        const text = messageInput.value.trim();

        if (text && !isTyping) {
            isTyping = true;
            chatSocket.send(JSON.stringify({
                type: 'typing_start',
                username: username
            }));
        }

        if (!text && isTyping) {
            isTyping = false;
            chatSocket.send(JSON.stringify({
                type: 'typing_stop',
                username: username
            }));
        }
    });

    function updateNotificationUI() {
        const badge = document.getElementById('notification-badge');
        badge.textContent = unreadNotifications.length;
        badge.classList.remove('hidden');
    }

    const chatMain = document.querySelector('main');

    chatMain.addEventListener('focusin', () => {
        unreadNotifications = [];
        const badge = document.getElementById('notification-badge');
        badge.textContent = '0';
    });
  </script>
</body>
</html>