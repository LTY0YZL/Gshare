{% load tailwind_cli %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat Room</title>
  {% tailwind_css %}
</head>

<body class="bg-neutral-100 text-gray-800">
  {% include "navbar.html" %}

  <!-- Grid Layout -->
  <div class="grid grid-cols-[auto_1fr_auto] h-screen overflow-hidden relative">

    <!-- LEFT SIDEBAR -->
    <aside id="left-sidebar"
      class="bg-blue-900/95 text-white w-64 transition-all duration-300 overflow-y-auto">
      <div class="p-4 border-b border-blue-800">
        <h2 class="text-xl font-semibold mb-4">Direct Messages</h2>
        <ul class="space-y-1 mb-6">
          {% for dm in dm_list %}
            <li>
              <a href="{% url 'direct_message' dm.id %}" 
                 class="block px-3 py-2 rounded hover:bg-blue-700 transition">{{ dm.other_user.username }}</a>
            </li>
          {% empty %}
            <p class="text-gray-300 text-sm">No direct messages yet.</p>
          {% endfor %}
        </ul>

        <h2 class="text-xl font-semibold mb-2">Groups</h2>
        <ul class="space-y-1">
          {% for group in groups %}
            <li>
              <a href="{% url 'chat_room' group.slug %}"
                 class="block px-3 py-2 rounded hover:bg-blue-700 transition">{{ group.name }}</a>
            </li>
          {% empty %}
            <p class="text-gray-300 text-sm">You're not part of any groups yet.</p>
          {% endfor %}
        </ul>
      </div>
    </aside>

    <!-- CHAT SECTION -->
    <main class="flex flex-col h-full min-h-0"> <!-- added min-h-0 -->
      <div id="chat-log"
        class="flex flex-col flex-1 overflow-y-auto px-6 py-4 space-y-2 text-sm leading-snug min-h-0">
        {% for message in messages %}
          <div
            class="max-w-[70%] px-4 py-2 rounded-2xl break-words
              {% if message.sender.username == user.username %}
                bg-blue-600 text-white self-end
              {% else %}
                bg-gray-300 text-gray-900 self-start
              {% endif %}">
            <span class="font-semibold">{{ message.sender.username }}:</span> {{ message.content }}
            {% if message.image %}
              <br><img src="{{ message.image }}" alt="Image" class="max-w-xs rounded-lg mt-2">
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <!-- Image Preview -->
    <div class="sticky bottom-0 z-10 bg-white border-t border-gray-300">
        <div class="flex items-center gap-3 p-4">
          <div id="image-preview" class="hidden items-center gap-3">
            <img id="preview-img" class="w-20 h-20 object-cover rounded-lg shadow-sm" alt="Preview">
            <button id="remove-image-btn" class="text-red-600 hover:text-red-800">Remove</button>
          </div>

          <input id="chat-message-input"
            class="flex-1 border border-gray-300 rounded-xl px-4 py-2 text-base focus:ring-2 focus:ring-blue-400 outline-none"
            type="text" placeholder="Type your message..." />
          <input id="image-input" type="file" accept="image/*" style="display:none;" />

          <button id="image-upload-btn" class="bg-gray-600 text-white px-4 py-2 rounded-xl hover:bg-gray-700 transition font-medium">
              +
          </button>

          <button id="chat-message-submit"
            class="bg-blue-600 text-white px-5 py-2 rounded-xl hover:bg-blue-700 transition font-medium">Send</button>
        </div>
      </div>
    </main>

    <!-- RIGHT SIDEBAR -->
    <aside id="right-sidebar"
      class="bg-blue-900/95 text-white w-64 transition-all duration-300 overflow-y-auto">
      <div class="p-4 border-b border-blue-800">
        {% if thread %}
          <h2 class="text-lg font-semibold">Direct Message</h2>
          <p class="text-gray-300 text-sm">Chatting with <span class="font-semibold text-white">{{ other_user.username }}</span></p>
        {% else %}
          <h2 class="text-lg font-semibold mb-1">Room: {{ room_name }}</h2>
          <p class="text-gray-300 text-sm">Room Code: {{ room_code }}</p>
        {% endif %}
      </div>

      {% if members %}
      <div class="p-4 border-b border-blue-800">
        <h3 class="text-lg font-semibold mb-3">Members</h3>
        <ul class="space-y-1 max-h-48 overflow-y-auto">
          {% for member in members %}
            <li>
              <span class="block px-3 py-2 rounded hover:bg-blue-700 transition">{{ member.username }}</span>
            </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Display Persistent Notifications -->
      <div class="p-4 border-b border-blue-800">
        <h3 class="text-lg font-semibold mb-3">Notifications</h3>
        <div id="notification-list" class="space-y-2 max-h-48 overflow-y-auto">
          {% if notifications %}
            {% for notification in notifications %}
              <div class="bg-blue-800 rounded-lg p-3 text-sm break-words">
                <p class="text-gray-200">{{ notification.message }}</p>
                <p class="text-xs text-gray-400 mt-1">{{ notification.created_at|date:"H:i" }}</p>
              </div>
            {% empty %}
              <p class="text-gray-300 text-sm">No new notifications</p>
            {% endfor %}
          {% else %}
            <p class="text-gray-300 text-sm">No notifications</p>
          {% endif %}
        </div>
      </div>

      <!-- Badge for unread count -->
      <div class="p-4">
        <div id="notification-badge" class="fixed top-4 right-4 bg-red-600 text-white px-3 py-1 rounded-full shadow-lg hidden">
          <span id="badge-count">0</span>
        </div>
      </div>
    </aside>

    <!-- FLOATING TOGGLE BUTTONS -->
    <button id="toggle-left"
      class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-blue-700 text-white p-2 rounded-full shadow-lg hover:bg-blue-600 transition z-50">
      ⮜
    </button>

    <button id="toggle-right"
      class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-blue-700 text-white p-2 rounded-full shadow-lg hover:bg-blue-600 transition z-50">
      ⮞
    </button>
  </div>

  <!-- WebSocket Script -->
  <script>
    const roomName = "{{ room_name }}";
    const username = "{{ user.username }}";

    {% if thread %}
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/dm/' + '{{ thread.id }}' + '/');
    {% else %}
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + roomName + '/');
    {% endif %}

    const chatLog = document.querySelector('#chat-log');
    let selectedImage = null;
    let isTyping = false;
    let unreadNotifications = [];


    // load notifications on page load
    window.addEventListener('load', () => {
      const notifications = document.querySelectorAll('#notification-list > div');
      updateNotificationBadge(notifications.length);
    });

    function updateNotificationBadge(count) {
      const badge = document.getElementById('notification-badge');
      const badgeCount = document.getElementById('badge-count');

      if (count > 0) {
          badgeCount.textContent = count;
          badge.classList.remove('hidden');
      } else {
          badge.classList.add('hidden');
      }
    }

    // Image Upload Button
    document.getElementById('image-upload-btn').addEventListener('click', () => {
        document.getElementById('image-input').click();
    });

    // File Input Change
    document.getElementById('image-input').addEventListener('change', (e) => {
        selectedImage = e.target.files[0];
        if (selectedImage) {
            showImagePreview(selectedImage);
            console.log("Image selected:", selectedImage.name);
        }
    });

    // Paste Image
    document.getElementById('chat-message-input').addEventListener('paste', (e) => {
        const items = e.clipboardData.items;

        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                e.preventDefault();
                selectedImage = item.getAsFile();
                showImagePreview(selectedImage);
                console.log("Image pasted:", selectedImage.name);
                break;
            }
        }
    });

    // Show Image Preview
    function showImagePreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewDiv = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            previewImg.src = e.target.result;
            previewDiv.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    // Remove Image Button
    document.getElementById('remove-image-btn').addEventListener('click', () => {
        selectedImage = null;
        document.getElementById('image-preview').classList.add('hidden');
        document.getElementById('image-input').value = '';
    });

    // Handle Messages
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.type === 'message') {
            renderMessage(data);
            chatLog.scrollTop = chatLog.scrollHeight;

            removeTypingIndicator(data.username);
        }

        if (data.type === 'notification' && data.username !== username) {
          const notificationList = document.getElementById('notification-list');
          const notificationDiv = document.createElement('div');
          notificationDiv.className = 'bg-blue-800 rounded-lg p-3 text-sm break-words';
          const now = new Date();
          const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                          now.getMinutes().toString().padStart(2, '0');
          notificationDiv.innerHTML = `
            <p class="text-gray-200">${data.title}</p>
            <p class="text-gray-300">${data.body}</p>
            <p class="text-xs text-gray-400 mt-1">${timeStr}</p>
            `;
          notificationList.insertBefore(notificationDiv, notificationList.firstChild);

          const allNotifications = document.querySelectorAll('#notification-list > div');
          updateNotificationBadge(allNotifications.length);

        }

        if (data.type === 'typing_start') {
            showTypingIndicator(data.username);
        }

        if (data.type === 'typing_stop') {
            removeTypingIndicator(data.username);
        }
    };

    // Send Message
    document.querySelector('#chat-message-submit').onclick = function () {
        const input = document.querySelector('#chat-message-input');
        const msg = input.value.trim();

        if (!msg && !selectedImage) return;

        if (selectedImage) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageData = event.target.result;
                chatSocket.send(JSON.stringify({
                    type: 'message',
                    username: username,
                    message: msg,
                    image: imageData
                }));
                input.value = '';
                selectedImage = null;
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('image-input').value = '';
                isTyping = false;
            };
            reader.readAsDataURL(selectedImage);
        } else {
            chatSocket.send(JSON.stringify({
                type: 'message',
                username: username,
                message: msg
            }));
            input.value = '';
            isTyping = false;
        }
    };

    // Enter Key to Send
    document.querySelector('#chat-message-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') document.querySelector('#chat-message-submit').click();
    });

    // Sidebar Toggle Logic
    const leftSidebar = document.getElementById('left-sidebar');
    const rightSidebar = document.getElementById('right-sidebar');
    const toggleLeft = document.getElementById('toggle-left');
    const toggleRight = document.getElementById('toggle-right');

    let leftOpen = true;
    let rightOpen = true;

    toggleLeft.addEventListener('click', () => {
        leftOpen = !leftOpen;
        leftSidebar.style.width = leftOpen ? '16rem' : '0';
        leftSidebar.style.padding = leftOpen ? '1rem' : '0';
        toggleLeft.innerText = leftOpen ? '⮜' : '⮞';
    });

    toggleRight.addEventListener('click', () => {
        rightOpen = !rightOpen;
        rightSidebar.style.width = rightOpen ? '16rem' : '0';
        rightSidebar.style.padding = rightOpen ? '1rem' : '0';
        toggleRight.innerText = rightOpen ? '⮞' : '⮜';
    });

    // Typing Indicators
    function showTypingIndicator(user) {
        let indicator = document.getElementById(`typing-${user}`);
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = `typing-${user}`;
            indicator.className = 'text-gray-500 italic text-sm self-start';
            indicator.textContent = `${user} is typing...`;
            chatLog.appendChild(indicator);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    }

    function removeTypingIndicator(user) {
        const indicator = document.getElementById(`typing-${user}`);
        if (indicator) {
            indicator.remove();
        }
    }

    const messageInput = document.querySelector('#chat-message-input');

    messageInput.addEventListener('input', () => {
        const text = messageInput.value.trim();

        if (text && !isTyping) {
            isTyping = true;
            chatSocket.send(JSON.stringify({
                type: 'typing_start',
                username: username
            }));
        }

        if (!text && isTyping) {
            isTyping = false;
            chatSocket.send(JSON.stringify({
                type: 'typing_stop',
                username: username
            }));
        }
    });

    function updateNotificationUI() {
        const badge = document.getElementById('notification-badge');
        badge.textContent = unreadNotifications.length;
        badge.classList.remove('hidden');
    }

    const chatMain = document.querySelector('main');

    chatMain.addEventListener('focusin', () => {
        unreadNotifications = [];
        const badge = document.getElementById('notification-badge');
        badge.textContent = '0';
    });


    async function loadHistory() {
      let url;

      {% if thread %}
          url = `/groups/history/dm/{{ thread.id }}/`;
      {% else %}
          url = `/groups/history/${roomName}/`;
      {% endif %}
      console.log(url);

      const res = await fetch(url);
      const data = await res.json();
      data.messages.forEach(msg => renderMessage(msg));
    }

    function renderMessage(msg) {
      const messageDiv = document.createElement('div');
      const isSelf = msg.username === username;

      messageDiv.className = `max-w-[70%] px-4 py-2 rounded-2xl break-words text-sm leading-snug ${
          isSelf ? 'bg-blue-600 text-white self-end' : 'bg-gray-300 text-gray-900 self-start'
      }`;

      messageDiv.innerHTML = `<span class='font-semibold'>${msg.username}:</span> ${msg.message}`;

      if (msg.image_url) {
          messageDiv.innerHTML += `<br><img src="${msg.image_url}" class="max-w-xs rounded-lg mt-2">`;
      }

      chatLog.appendChild(messageDiv);
  }

    window.addEventListener("load", async () => {
      await loadHistory();
      chatLog.scrollTop = chatLog.scrollHeight;
  });

  </script>
</body>
</html>