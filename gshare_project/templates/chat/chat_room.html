<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Chat</title>
  <style>
    #chat-log { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; }
    .message-self { text-align: right; color: blue; }
    .message-other { text-align: left; color: green; }
  </style>
</head>
<body>
  <div id="chat-log"></div>
  <input id="chat-message-input" type="text" placeholder="Type a message...">
  <input id="chat-image-input" type="file" accept="image/*" style="display:none;">

  <button id="chooseImageBtn">+</button>

  <div id="imagePreviewContainer" style="display:none;">
    <img id="imagePreview" style="max-width:150px; max-height:150px; border-radius:8px;">
    <button id="removeImageBtn">✖</button>
  </div>
  <button id="chat-message-submit">Send</button>

 <script>
  // Convert Django template variables safely into JS values.
  const GROUP_ID = {% if room_name %} "{{ room_name }}" {% else %} null {% endif %};
  const THREAD_ID = {% if thread %} {{ thread.id }} {% else %} null {% endif %};

  const imageInput = document.getElementById("chat-image-input");
  const chooseImageBtn = document.getElementById("chooseImageBtn");
  const imagePreview = document.getElementById("imagePreview");
  const previewContainer = document.getElementById("imagePreviewContainer");
  const removeImageBtn = document.getElementById("removeImageBtn");
  const messageInput = document.getElementById("chat-message-input");

  let selectedImageFile = null;



// PREVIEW IMAGE FUNCTION
function loadImagePreview(file) {
    const url = URL.createObjectURL(file);
    imagePreview.src = url;
    previewContainer.style.display = "inline-block";
}

  chooseImageBtn.addEventListener("click", () => {
    imageInput.click();
});

// WHEN USER SELECTS AN IMAGE
imageInput.addEventListener("change", (e) => {
    if (e.target.files && e.target.files[0]) {
        selectedImageFile = e.target.files[0];
        loadImagePreview(selectedImageFile);
    }
});

// WHEN USER PASTES AN IMAGE
messageInput.addEventListener("paste", (e) => {
    const items = e.clipboardData.items;

    for (const item of items) {
      if (item.type.startsWith("image/")) {
          let blob = item.getAsFile();

          // Blob has NO name → wrap it in a File so Django + AWS accept it
          const file = new File([blob], `pasted_${Date.now()}.png`, {
              type: blob.type || "image/png"
          });

          selectedImageFile = file;
          loadImagePreview(file);
          e.preventDefault();
          break;
      }

    }
});

document.addEventListener("DOMContentLoaded", function() {
  const chatLog = document.getElementById("chat-log");
  const input = document.getElementById("chat-message-input");
  const sendBtn = document.getElementById("chat-message-submit");

  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + "=")) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }

function renderMessage(msg) {
    const div = document.createElement("div");
    div.textContent = msg.username + ": " + msg.content;
    
    if (msg.image_url) {
        const img = document.createElement("img");
        img.src = msg.image_url;
        img.style.maxWidth = "200px";
        img.style.display = "block";
        div.appendChild(img);
    }

    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
}

  async function loadMessages() {
    try {
      console.log("Loading messages for GROUP_ID:", GROUP_ID, "THREAD_ID:", THREAD_ID);
        const url = `/groups/list_messages/?group_id=${GROUP_ID}&thread_id=${THREAD_ID}`;
        console.log("Fetching messages from URL:", url);

        const res = await fetch(url, {
            method: "GET"
        });

        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();

        chatLog.innerHTML = "";
        console.log("Loaded messages:", data.messages);
        data.messages.forEach(renderMessage);

    } catch(err) {
        console.error("Error loading messages:", err);
    }
}




// REMOVE IMAGE BUTTON
removeImageBtn.addEventListener("click", () => {
    selectedImageFile = null;
    imagePreview.src = "";
    previewContainer.style.display = "none";
    imageInput.value = ""; // clear file input
});

  async function sendMessage() {
    const msg = input.value.trim();

    const formData = new FormData();
    formData.append("content", msg);
    if (GROUP_ID) formData.append("group_id", GROUP_ID);
    if (THREAD_ID) formData.append("thread_id", THREAD_ID);
    if (selectedImageFile) {
        formData.append("image_file", selectedImageFile);
    }

    const res2 = await fetch("/groups/send_message/", {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken")
        },
        body: formData,
    });

    if (res2.ok) {
        input.value = "";
        selectedImageFile.value = null;
        imageInput.value = ""; // clear file input
        loadMessages();
        removeImageBtn.click(); // clear preview

    }
}


  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

  loadMessages();
});
</script>


</body>
</html>
