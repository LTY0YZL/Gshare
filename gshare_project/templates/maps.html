{% load tailwind_cli %}
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maps</title>
    {% tailwind_css %}
    <style>
    </style>
</head>
{% include "navbar.html" %}
{% include "components/messages.html" %}
<body class="bg-[#D8D8D8] h-screen">
    

    <div class="h-full flex items-center justify-center">
        {% comment %} <button id="openPopup" class="bg-[#150931] text-white flex justify-center items-center w-32 h-32 rounded-lg transform translate-x-full transition-transform duration-300">
            Open Popup
        </button> {% endcomment %}
        <div id="map_popup" class="flex justify-center items-center w-full">
            <div style="width: 100%; height: 39rem;" id='map' class="h-96 border border-gray-300 rounded-lg shadow-lg">

            </div>
        </div>
        <button id="shareBtn" class="fixed bottom-6 left-6 px-4 py-2 rounded-full shadow-lg bg-blue-600 text-white">
            Start Sharing
        </button>
    </div>

    <!-- pop up html --> 
    <div id="popup" class="fixed top-0 right-0 w-full md:w-1/3 h-full max-h-screen bg-white shadow-2xl z-50 transition-transform transform translate-x-full flex flex-col">
        <!-- header -->
        <div class="flex justify-between items-center border-b p-4">
            <button id="closePopup" class="text-gray-500 hover:text-gray-700 ml-auto text-3xl">&times;</button>
        </div>

        <!-- tabs -->
        <div class="flex items-center justify-center border-b p-2">
            <button id="shop" class="bg-[#EBE5FA] w-1/2 h-12 text-lg font-bold">Shopping Cart</button>
            <button id="person" class="bg-white w-1/2 h-12 text-lg font-bold hover:bg-[#B299EA]">People</button>
        </div>

        <!-- scrollable content -->
        <div id="shoppingcart" class="flex-1 overflow-y-auto p-6">
            <div id="popup-content"></div>
        </div>

        <div id="people" class="hidden flex-1 overflow-y-auto p-6"></div>
    </div>

     {% csrf_token %}
     <script>
        let CarOverlay; 
        let myCurrentRole = 'buyer';

        //const openPopup = document.getElementById('openPopup'); 
        const closePopup = document.getElementById('closePopup');
        const shop = document.getElementById('shop');
        const person = document.getElementById('person');
        const map_popup = document.getElementById('map_popup');
        const shoppingcart = document.getElementById('shoppingcart');
        const people = document.getElementById('people');

        closePopup.addEventListener('click', () => {
            const popup = document.getElementById('popup');
            popup.classList.add('translate-x-full');
        });

        // openPopup.addEventListener('click', () => {
        //     popup.classList.remove('translate-x-full');
        //     openPopup.classList.add('-translate-x-10');
        // }); 


        shop.addEventListener('click', () => {
            console.log('person clicked');
            shop.classList.add('bg-[#EBE5FA]');
            person.classList.remove('bg-[#EBE5FA]');
            shop.classList.remove('bg-white');
            person.classList.add('bg-white');
            shoppingcart.classList.remove('hidden');
            people.classList.add('hidden');
            shop.classList.remove('hover:bg-[#B299EA]');
            person.classList.add('hover:bg-[#B299EA]');

        });

        person.addEventListener('click', () => {
            console.log('person clicked');
            person.classList.add('bg-[#EBE5FA]');
            shop.classList.remove('bg-[#EBE5FA]');
            person.classList.remove('bg-white');
            shop.classList.add('bg-white');
            shoppingcart.classList.add('hidden');
            people.classList.remove('hidden');
            person.classList.remove('hover:bg-[#B299EA]');
            shop.classList.add('hover:bg-[#B299EA]');

            loadPeopleData();

        });

        const HUB_URL = (location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/ws/location/';
        const WANT_KEY = 'gshare.sharelocation.v1';

        {% comment %} add user id {% endcomment %}
        const CURRENT_UID = {{ request.user.id }};
        const CURRENT_VIEWER_ID = {{ viewer_id }};

        let pageWS  = null;
        let pageWatchId = null;

        let directionsService;
        let directionsRenderer;
        let lastRouteUpdate = 0;
        let activeStorePos = null;  
        let profilePos = null; 
        let storeMarker = null;

        let storeLegPolyline = null;    // driver to store
        let profileLegPolyline = null;  // store to profile
        let directLegPolyline = null;   // driver TO profile WITHOUT STORE,  JUST FOR TEST

        let myActiveMarker = null;
        let activeDriverId = null;
        let activeBuyerId = null;

        let hasAlertedStore = false;
        let hasAlertedUser = false;

        let fullPathPolyline = null;
        let carSymbol = null;
        let storeIcon = null;

        function circleIcon(fill, stroke) {
            if (typeof google === 'undefined') return null;
            return {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 7,
                fillOpacity: 0.9,
                fillColor: fill,
                strokeColor: stroke,
                strokeWeight: 2,
            };
        }

        function getPersonIcon(color) {
            if (typeof google === 'undefined') return null;
            const personPath = "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z";
            return {
                path: personPath,
                fillColor: color,
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 1,
                scale: 1.3,            
                anchor: new google.maps.Point(12, 12)
            };
        }

        const liveMarkers = new Map();  
        let meLiveMarker = null;   
        
        function getPinIcon(color) {
            if (typeof google === 'undefined') return null;
            return {
                path: google.maps.SymbolPath.MARKER, 
                fillColor: color,
                fillOpacity: 1,
                strokeColor: '#FFFFFF', 
                strokeWeight: 1,
                scale: 1.5, 
                labelOrigin: new google.maps.Point(0, -25)
            };
        }

        function getBearing(startLat, startLng, destLat, destLng) {
            const startLatRad = startLat * (Math.PI / 180);
            const startLngRad = startLng * (Math.PI / 180);
            const destLatRad = destLat * (Math.PI / 180);
            const destLngRad = destLng * (Math.PI / 180);
            const y = Math.sin(destLngRad - startLngRad) * Math.cos(destLatRad);
            const x = Math.cos(startLatRad) * Math.sin(destLatRad) -
                    Math.sin(startLatRad) * Math.cos(destLatRad) * Math.cos(destLngRad - startLngRad);
            let brng = Math.atan2(y, x);
            brng = brng * (180 / Math.PI);
            return (brng + 360) % 360;
        }

        function ensureLiveMarker(uid, username, role, isMe) {
            const effectiveRole = isMe ? myCurrentRole : role;

            if (isMe && meLiveMarker) return meLiveMarker;
            if (!isMe && liveMarkers.has(uid)) return liveMarkers.get(uid);

            let marker;

            if (effectiveRole === 'driver') {
                const initialPos = new google.maps.LatLng(40.7608, -111.8910);
                marker = new CarOverlay(initialPos, "{% static 'media/SimplePurpleCarTopView.svg' %}", map);
            } else if (isMe) {
                marker = new google.maps.Marker({
                    map,
                    title: "Me",
                    icon: getPersonIcon('#4285F4'),
                    position: { lat: 40.7608, lng: -111.8910 },
                    zIndex: 9999
                });
            } else {
                marker = new google.maps.Marker({
                    map,
                    title: username,
                    icon: getPinIcon('#EA4335'),
                    position: { lat: 40.7608, lng: -111.8910 }
                });
            }

            if (isMe) meLiveMarker = marker; else liveMarkers.set(uid, marker);
            return marker;
        }

        function subscribeHub() {
            if (pageWS) return;
            pageWS = new WebSocket(HUB_URL);

            pageWS.onmessage = (evt) => {
            const data = JSON.parse(evt.data || '{}');
            if (data.type !== 'loc') return;

            const isMe = data.uid === CURRENT_UID;

            if (!isMe && data.role !== 'driver') {
                return;
            }

            const m = ensureLiveMarker(data.uid, data.username, data.role, isMe);
            const isCar = (typeof m.update === 'function');
            const newPosLatLng = new google.maps.LatLng(data.lat, data.lng);
            const prevPos = m.getPosition ? m.getPosition() : null;

            if (prevPos && (data.role === 'driver' || isMe)) {
                const heading = getBearing(prevPos.lat(), prevPos.lng(), data.lat, data.lng);
                if (isCar) {
                    m.update(newPosLatLng, heading);
                } else {
                    m.setPosition(newPosLatLng);
                }
            } else {
                if (isCar) m.update(newPosLatLng, 0);
                else m.setPosition(newPosLatLng);
            }

            if (data.role === 'driver') {
                updateRouteFromDriver({ lat: data.lat, lng: data.lng });
                checkGeofences({ lat: data.lat, lng: data.lng });
            }
        };

            pageWS.onclose = () => {
                pageWS = null;
            };
        }

        function setShareBtn(on) {
            const b = document.getElementById('shareBtn');
            b.textContent = on ? 'Stop Sharing' : 'Start Sharing';
            b.style.color = "black";
        }

        function buildPathFromLeg(leg) {
            const path = [];
            leg.steps.forEach(step => {
                step.path.forEach(p => path.push(p));
            });
            return path;
        }

        function updateRouteFromDriver(driverPos) {
            if (!directionsService) return;
            if (!profilePos) {
                console.log("Destination not set. Click a marker first.");
                return; 
            }

            const now = Date.now();
            if (now - lastRouteUpdate < 2000) return; 
            lastRouteUpdate = now;

            const req = {
                origin: driverPos,
                destination: profilePos,
                travelMode: google.maps.TravelMode.DRIVING
            };
            
            if (activeStorePos) {
                req.waypoints = [{ location: activeStorePos, stopover: true }];
            }

            directionsService.route(req, (result, status) => {
                if (status !== 'OK') {
                    console.warn("Directions request failed (" + status + "). Car might be in the ocean?");
                    return;
                }

                const route = result.routes[0];
                
                if (storeLegPolyline) storeLegPolyline.setMap(null);
                if (profileLegPolyline) profileLegPolyline.setMap(null);
                if (directLegPolyline) directLegPolyline.setMap(null);
                if (fullPathPolyline) fullPathPolyline.setMap(null); 

                const fullPath = [];
                route.legs.forEach(leg => {
                    leg.steps.forEach(step => step.path.forEach(p => fullPath.push(p)));
                });
                
                fullPathPolyline = new google.maps.Polyline({
                    map,
                    path: fullPath,
                    strokeColor: '#e5e7eb',
                    strokeOpacity: 0.8,
                    strokeWeight: 8 
                });

                if (route.legs.length === 2) {
                    storeLegPolyline = new google.maps.Polyline({
                        map,
                        path: buildPathFromLeg(route.legs[0]),
                        strokeColor: '#EE0000', 
                        strokeWeight: 5,
                        zIndex: 10 
                    });
                    profileLegPolyline = new google.maps.Polyline({
                        map,
                        path: buildPathFromLeg(route.legs[1]),
                        strokeColor: '#66ccff', 
                        strokeWeight: 5,
                        zIndex: 10
                    });
                } else {
                    directLegPolyline = new google.maps.Polyline({
                        map,
                        path: buildPathFromLeg(route.legs[0]),
                        strokeColor: '#66ccff',
                        strokeWeight: 5,
                        zIndex: 10
                    });
                }
            });
        }

        function startSharingNow(role='buyer') {
            localStorage.setItem(WANT_KEY, '1');
            setShareBtn(true);

            if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
            if (pageWatchId !== null) return;
            if (!pageWS) subscribeHub();  

            function sendPing(lat, lng, acc) {
                if (pageWS && pageWS.readyState === 1) {
                    pageWS.send(JSON.stringify({ type: 'ping', lat, lng, role, accuracy: acc }));
                }
            }

            pageWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, accuracy } = pos.coords;
                    const driverPos = { lat: latitude, lng: longitude };
                    const me = ensureLiveMarker(CURRENT_UID, 'You', role, true);
                    
                    if (typeof me.update === 'function') {
                        const latLng = new google.maps.LatLng(latitude, longitude);
                        me.update(latLng, null); 
                    } else {
                        me.setPosition(driverPos);
                    }

                    sendPing(latitude, longitude, accuracy);
                    
                    if (role === 'driver' || CURRENT_UID === activeDriverId) {
                        updateRouteFromDriver(driverPos);
                    }
                },
                (err) => {
                    console.error(err);
                    alert('Location permission or GPS issue.');
                    stopSharingNow();
                },
                { enableHighAccuracy: true, maximumAge: 2000, timeout: 8000 }
            );
        }

        function stopSharingNow() {
            localStorage.removeItem(WANT_KEY);
            setShareBtn(false);
            if (pageWatchId !== null) {
                navigator.geolocation.clearWatch(pageWatchId);
                pageWatchId = null;
            }
        }

        document.getElementById('shareBtn').addEventListener('click', () => {
            if (localStorage.getItem(WANT_KEY)) stopSharingNow(); 
            else startSharingNow(myCurrentRole);
        });

        function afterMapReady() {
            subscribeHub();                         
            setShareBtn(!!localStorage.getItem(WANT_KEY));  
        }

        let map;
        let geocoder;
        let markers = {};

        {% comment %} const addresses_with_info = JSON.parse('{{ delivery_addresses_with_info_json|escapejs }}'); {% endcomment %}
        const user_address = '{{ user_address|escapejs }}';
        let fetchTimeout = null; // for debouncing


        function initMap() {
            const defaultLocation = { lat: 40.7608, lng: -111.8910 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 17,
                center: defaultLocation,
            });

            CarOverlay = class extends google.maps.OverlayView {
                constructor(position, image, map) {
                    super();
                    this.position = position;
                    this.image = image;
                    this.map = map;
                    this.div = null;
                    this.rotation = 0;
                    this.setMap(map);
                }

                onAdd() {
                    const div = document.createElement("div");
                    div.style.position = "absolute";
                    div.style.border = "none";
                    div.style.width = "60px";  
                    div.style.height = "30px";
                    div.style.transformOrigin = "center"; 
                    
                    const img = document.createElement("img");
                    img.src = this.image;
                    img.style.width = "100%";
                    img.style.height = "100%";
                    img.style.position = "absolute";
                    
                    div.appendChild(img);
                    this.div = div;

                    const panes = this.getPanes();
                    panes.overlayMouseTarget.appendChild(div);
                }

                draw() {
                    const overlayProjection = this.getProjection();
                    if (!overlayProjection || !this.div) return;
                    const pos = overlayProjection.fromLatLngToDivPixel(this.position);
                    const x = pos.x - 30; 
                    const y = pos.y - 15; 

                    this.div.style.left = x + "px";
                    this.div.style.top = y + "px";
                    this.div.style.transform = `rotate(${this.rotation}deg)`;
                }

                onRemove() {
                    if (this.div) {
                        this.div.parentNode.removeChild(this.div);
                        this.div = null;
                    }
                }

                update(newPosition, newHeading) {
                    this.position = newPosition;
                    if (newHeading !== null) {
                        this.rotation = newHeading;
                    }
                    this.draw(); 
                }
                
                getPosition() {
                    return this.position;
                }
            };

            storeIcon = {
                url: "{% static 'media/shop.png' %}",
                scaledSize: new google.maps.Size(36, 36),
                anchor: new google.maps.Point(18, 18),
            };
            
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({map, suppressMarkers: true});

            if (user_address) {
                geocoder.geocode({ 'address': user_address }, (results, status) => {
                    if (status === 'OK') {
                        map.setCenter(results[0].geometry.location);
                    }
                });
            }

            map.addListener("idle", () => {
                if (fetchTimeout) clearTimeout(fetchTimeout);
                fetchTimeout = setTimeout(fetchMapData, 500); 
            });
            setInterval(fetchMapData, 5000);
            afterMapReady();
        }

        let user = "";

        function fetchMapData() {

            const bounds = map.getBounds();
            if (!bounds) {
                console.warn("Map bounds not available yet.");
                return;
            }

            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            const maxLat = ne.lat();
            const maxLng = ne.lng();
            const minLat = sw.lat();
            const minLng = sw.lng();
            console.log(`Map bounds: NE(${maxLat}, ${maxLng}), SW(${minLat}, ${minLng})`);

            // Fetch maps data asynchronously after map loads
            const url = `/maps/maps-data/${minLat}/${minLng}/${maxLat}/${maxLng}/`;
            fetch(url)
                .then(res => {
                    const userName = res.headers.get('X-User-Name');
                    console.log("fetched username from header:", userName);
                    user = userName;
                    return res.json();
                })
                .then(data => {
                    console.log("maps data received:", data);
                    addMarkers(data);

                    loadPeopleData();
                })
                .catch(err => console.error("Error fetching delivery data:", err));
        }

        function addMarkers(addressGroups) {
            const bounds = map.getBounds();
            if (!bounds) return;

            for (const [address, marker] of Object.entries(markers)) {
                if (!bounds.contains(marker.getPosition())) {
                    marker.setMap(null);
                    delete markers[address];
                }
            }

            let viewerIsDriver = false;
            addressGroups.forEach(group => {
                if (group.orders.some(o =>
                    o.driver_id == CURRENT_VIEWER_ID &&
                    (o.status === 'inprogress' || o.status === 'accepted')
                )) {
                    viewerIsDriver = true;
                }
            });

            if (viewerIsDriver && myCurrentRole !== 'driver') {
                updateLocalRole('driver');
            }

            addressGroups.forEach(group => {
                const address = group.address;
                if (!address || address.trim().length < 5) return;
                if (markers[address]) return;

                geocoder.geocode({ address }, (results, status) => {
                    if (status !== 'OK' || !results[0]) return;

                    const location = results[0].geometry.location;
                    const isMyOrder = group.orders.some(o => o.user_id == CURRENT_UID);
                    const amIDriver = group.orders.some(o => o.driver_id == CURRENT_VIEWER_ID);

                    if (isMyOrder && amIDriver && !group.is_store) {
                        return;
                    }

                    let markerIcon;
                    let markerZIndex = 1;

                    if (group.is_store) {
                        markerIcon = storeIcon;
                        markerZIndex = 200;
                    } else {
                        markerIcon = getPinIcon('#EA4335');
                        markerZIndex = isMyOrder ? 80 : 40;
                    }

                    const marker = new google.maps.Marker({
                        map,
                        position: location,
                        title: group.is_store ? `Store: ${address}` : `Orders at ${address}`,
                        icon: markerIcon,
                        zIndex: markerZIndex,
                    });

                    if (!group.is_store) {
                        marker.addListener('click', () => {
                            showPopup(group);
                            setTimeout(() => shop.click(), 100);  

                            profilePos = location;
                            const order = group.orders && group.orders.length > 0 ? group.orders[0] : null;
                            if (!order) return;

                            activeDriverId = order.driver_id || null;
                            activeBuyerId = order.user_id || null;

                            const rawLat = order.store_lat;
                            const rawLng = order.store_lng;
                            const lat = rawLat !== null && rawLat !== undefined ? parseFloat(rawLat) : NaN;
                            const lng = rawLng !== null && rawLng !== undefined ? parseFloat(rawLng) : NaN;

                            if (!Number.isNaN(lat) && !Number.isNaN(lng)) {
                                activeStorePos = { lat, lng };

                                if (meLiveMarker && myCurrentRole === 'driver') {
                                    updateRouteFromDriver(meLiveMarker.getPosition());
                                }

                                return;
                            }

                            if (order.store_address) {
                                const geocodeRequest = {
                                    address: order.store_address,
                                    bounds: map.getBounds(),
                                    componentRestrictions: { country: 'US' },
                                };
                                geocoder.geocode(geocodeRequest, (results2, status2) => {
                                    if (status2 !== 'OK' || !results2[0]) {
                                        if (meLiveMarker && myCurrentRole === 'driver') {
                                            updateRouteFromDriver(meLiveMarker.getPosition());
                                        }
                                        return;
                                    }
                                    const storeLoc = results2[0].geometry.location;
                                    activeStorePos = storeLoc;
                                    updateRouteFromDriver(meLiveMarker ? meLiveMarker.getPosition() : storeLoc);
                                });
                            } else {
                                activeStorePos = null;
                                if (storeMarker) {
                                    storeMarker.setMap(null);
                                    storeMarker = null;
                                }
                                if (meLiveMarker && myCurrentRole === 'driver') {
                                    updateRouteFromDriver(meLiveMarker.getPosition());
                                }
                            }
                        });
                    }

                    markers[address] = marker;

                    const hasMyActiveOrder = group.orders.some(o =>
                        (o.status === 'inprogress' || o.status === 'accepted') &&
                        (o.user_id === CURRENT_VIEWER_ID || o.driver_id === CURRENT_VIEWER_ID)
                    );

                    if (hasMyActiveOrder && !group.is_store) {
                        myActiveMarker = marker;
                        google.maps.event.trigger(marker, 'click');
                    }
                });
            });
        }

        function updateLocalRole(newRole) {
            myCurrentRole = newRole;

            if (meLiveMarker) {
                if (typeof meLiveMarker.setMap === 'function') {
                    meLiveMarker.setMap(null);
                } else if (typeof meLiveMarker.onRemove === 'function') {
                    meLiveMarker.onRemove();
                }
                meLiveMarker = null;
            }

            if (localStorage.getItem(WANT_KEY)) {
                stopSharingNow();
                setTimeout(() => startSharingNow(myCurrentRole), 500);
            }
        }

        function checkGeofences(driverPos) {
            const driverLatLng = new google.maps.LatLng(driverPos.lat, driverPos.lng);
            
            if (activeStorePos && !hasAlertedStore) {
                const distStore = google.maps.geometry.spherical.computeDistanceBetween(
                    driverLatLng, 
                    activeStorePos
                );
                if (distStore < 500) { 
                    showToast("Driver is arriving at the store");
                    hasAlertedStore = true;
                }
            }

            if (profilePos && !hasAlertedUser) {
                const distUser = google.maps.geometry.spherical.computeDistanceBetween(
                    driverLatLng, 
                    profilePos
                );
                if (distUser < 500) { 
                    showToast("Driver is arriving at your location");
                    hasAlertedUser = true;
                }
            }
        }

        function showToast(message) {
            const toast = document.createElement("div");
            toast.className = "fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded shadow-xl z-50 animate-bounce";
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        let popupJustOpened = false;

        function showPopup(group) {
            console.log("popup");
            let ordersHTML = group.orders.map(order => {
            const viewerName = user;
            const isBuyer  = (group.orders[0].user === viewerName);
            const isDriver = (order.driver_name === viewerName);

            let actionHtml = '';

            if (order.status === 'placed') {
                const buttonText = isBuyer ? 'Take own order' : 'Send Request';

                actionHtml = `
                    <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2"
                            onclick="createDelivery(${order.order_id}); changeOrderStatus(${order.order_id}, 'pending')">
                        ${buttonText}
                    </button>
                    `;
                } else if (order.status === 'inprogress') {
                const isBuyer  = (order.user_id === CURRENT_VIEWER_ID);
                const isDriver = (order.driver_id === CURRENT_VIEWER_ID);

                let baseText = '';

                if (isBuyer && isDriver) {
                    baseText = `
                        <p class="mt-2 text-green-700 font-semibold">
                            You are picking up your own order.
                        </p>
                        <p class="mt-1 text-black font-semibold">
                            Delivery in progress...
                        </p>
                    `;
                }
                else if (isDriver) {
                    baseText = `
                        <p class="mt-2 text-green-700 font-semibold">
                            You are delivering this order.
                        </p>
                        <p class="mt-1 text-black font-semibold">
                            Delivery in progress...
                        </p>
                    `;
                }
                else if (isBuyer) {
                    baseText = `
                        <p class="mt-2 text-blue-700 font-semibold">
                            Your order is in progress.<br>
                            Driver: <b>${order.driver_name || 'TBD'}</b>
                        </p>
                        <p class="mt-1 text-black font-semibold">
                            Delivery in progress...
                        </p>
                    `;
                }
                else {
                    baseText = `
                        <p class="mt-2 text-gray-500">
                            This order has already been accepted${order.driver_name ? ' by <b>' + order.driver_name + '</b>' : ''}.
                        </p>
                        <p class="mt-1 text-black font-semibold">
                            Delivery in progress...
                        </p>
                    `;
                }
                actionHtml = baseText;
            } else {
                actionHtml = `
                    <p class="mt-2 text-gray-500">
                        Order status: ${order.status}
                    </p>
                `;
            }

            return `
                <div class="border-t border-gray-300 mt-4 pt-4">
                    <p class="text-gray-700 text-xl"><b>Address:</b> ${group.address}</p>
                    <ul class="list-disc pl-6">
                        ${order.items.map(item => `
                            <li class="mb-1 border border-gray-300 rounded-lg p-2 mt-2">
                                <span class="font-semibold">${item.name}</span>:
                                <span class="font-semibold">${item.quantity} Ã— $${item.price} =</span>
                                <span class="text-blue-700 font-bold">$${item.total.toFixed(2)}</span>
                            </li>
                        `).join('')}
                    </ul>
                    <p class="text-right text-lg font-bold mt-2">
                        Subtotal: $${order.subtotal.toFixed(2)}
                    </p>
                    ${actionHtml}
                </div>
            `;
        }).join('');

        const popup = document.getElementById('popup');
        console.log("popup element found?", popup);
        console.log("popup classes before:", popup?.classList.value);

        const userName = group.orders[0].user;
        const userId   = group.orders[0].user_id;

        popup.classList.remove('translate-x-full');
        console.log("popup classes after:", popup.classList.value);

        document.getElementById('popup-content').innerHTML = `
            <div class="space-y-4">
                <a href="/profile/${userId}/" class="no-underline hover:underline">
                    <h2 class="text-4xl font-bold mb-2 text-center">${userName}</h2>
                </a>
                ${ordersHTML}
            </div>
        `;

        console.log("end");
        popupJustOpened = true
    }

    function confirmDelivered(orderId) {
        fetch(`/orders/${orderId}/confirm_delivery/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({}),
        })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                alert(data.error || 'Failed to confirm delivery');
                return;
            }
            if (data.fully_delivered) {
                alert('Order marked delivered by both buyer and driver.');
                window.location.reload();
            } else {
                alert('Thanks! Waiting for the other person to confirm.');
            }
        })
        .catch(err => {
            console.error(err);
            alert('Error confirming delivery.');
        });
    }

        function geocodeAddress() {
            const address = document.getElementById('input_location').value;
            geocoder.geocode({ 'address': address }, (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    document.getElementById('input_location').value = '';


                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        } 

        function loadPeopleData() {

            const bounds = map.getBounds();
            if (!bounds) {
                console.warn("Map bounds not available yet.");
                return;
            }

            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            const maxLat = ne.lat();
            const maxLng = ne.lng();
            const minLat = sw.lat();
            const minLng = sw.lng();
            console.log(`Map bounds: NE(${maxLat}, ${maxLng}), SW(${minLat}, ${minLng})`);

            // Fetch maps data asynchronously after map loads
            const url = `/maps/people-data/${minLat}/${minLng}/${maxLat}/${maxLng}/`;
            fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    console.log("People data received:", data);
                    const peopleDiv = document.getElementById('people');

                    // Example rendering of people data
                    peopleDiv.innerHTML = `
                        <div class="p-4 space-y-2">
                            <h3 class="text-2xl font-bold mb-4">Nearby People</h3>
                            ${data.people.map(person => `
                                <div class="border p-3 rounded-lg bg-gray-100">
                                    <a href="/profile/${person.id}/" class="no-underline hover:underline">
                                        <p class="font-semibold">${person.name}</p>
                                    </a>
                                    <p class="text-sm text-gray-600">${person.address}</p>
                                    <p class="text-sm text-gray-600">Order Price: $${person.order_data.subtotal}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                })
                .catch(error => {
                    console.error("Error loading people data:", error);
                    document.getElementById('people').innerHTML = "<p class='text-red-500 p-4'>Failed to load people data.</p>";
                });
            }

        function changeOrderStatus(orderId, newStatus) {
            fetch(`/change_order_status/${orderId}/${newStatus}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) { 
                    alert('Updated!'); 
                    if (newStatus === 'inprogress') {
                        updateLocalRole('driver');
                    }
                    window.location.reload(); 
                }
                else alert('Failed');
            });
        }

        function createDelivery(orderId) {
            fetch(`/create_delivery/${orderId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token for security
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Delivery created successfully!');
                    
                } else {
                    console.log('Failed to create delivery.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                console.log('An error occurred while creating the delivery.');
            });
        }

        {% comment %} window.addEventListener('load', initMap) {% endcomment %}
    </script>

    <script async defer
        {% comment %} src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"> {% endcomment %}
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry&callback=initMap">

    </script>

</body>