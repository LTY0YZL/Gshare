{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maps</title>
    <link rel="stylesheet" href="{% static 'dist/tailwindcss.css' %}">
    <style>
    </style>
</head>
<body class="bg-[#D8D8D8] h-screen">
    
    {% include "navbar.html" %}

    <div class="h-full flex items-center justify-center">
        {% comment %} <button id="openPopup" class="bg-[#150931] text-white flex justify-center items-center w-32 h-32 rounded-lg transform translate-x-full transition-transform duration-300">
            Open Popup
        </button> {% endcomment %}
        <div id="map_popup" class="flex justify-center items-center w-full">
            <div id='map' class="w-2/3  h-96 mt-4 border border-gray-300 rounded-lg shadow-lg">

            </div>
        </div>
    </div>

    <!-- pop up html --> 
    <div id="popup" class="fixed top-0 right-0 w-1/3 h-full bg-white shadow-2xl z-50 transition-transform transform translate-x-full">
        <div class="flex justify-between items-center border-b">
            <button id="closePopup" class="text-gray-500 hover:text-gray-700 ml-auto">&times;</button>

        </div>

        <div class="flex items-center justify-center border-b-gray">
            <button id="shop" class="bg-[#EBE5FA] w-1/2 h-1/12 text-lg font-bold">Shopping Cart</button>
            <button id="person" class="bg-white w-1/2 h-1/12 text-lg font-bold hover:bg-[#B299EA]">People</button>
        </div>

        <div id="shoppingcart">
            <div id="popup-content" class="p-6"></div>

        </div>

        <div id="people" class="hidden">

        </div>


     </div>
     {% csrf_token %}
     <script>
        //const openPopup = document.getElementById('openPopup'); 
        const closePopup = document.getElementById('closePopup');
        const shop = document.getElementById('shop');
        const person = document.getElementById('person');
        const map_popup = document.getElementById('map_popup');
        const shoppingcart = document.getElementById('shoppingcart');
        const people = document.getElementById('people');

        // openPopup.addEventListener('click', () => {
        //     popup.classList.remove('translate-x-full');
        //     openPopup.classList.add('-translate-x-10');
        // }); 


        shop.addEventListener('click', () => {
            console.log('person clicked');
            shop.classList.add('bg-[#EBE5FA]');
            person.classList.remove('bg-[#EBE5FA]');
            shop.classList.remove('bg-white');
            person.classList.add('bg-white');
            shoppingcart.classList.remove('hidden');
            people.classList.add('hidden');
            shop.classList.remove('hover:bg-[#B299EA]');
            person.classList.add('hover:bg-[#B299EA]');

        });

        person.addEventListener('click', () => {
            console.log('person clicked');
            person.classList.add('bg-[#EBE5FA]');
            shop.classList.remove('bg-[#EBE5FA]');
            person.classList.remove('bg-white');
            shop.classList.add('bg-white');
            shoppingcart.classList.add('hidden');
            people.classList.remove('hidden');
            person.classList.remove('hover:bg-[#B299EA]');
            shop.classList.add('hover:bg-[#B299EA]');

            loadPeopleData();

        });

        let map;
        let geocoder;
        let markers = {};
        {% comment %} const addresses_with_info = JSON.parse('{{ delivery_addresses_with_info_json|escapejs }}'); {% endcomment %}
        const user_address = '{{ user_address|escapejs }}';
        let fetchTimeout = null; // for debouncing


        function initMap() {
            // Create a map centered at a specific location
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 17
            });
            geocoder = new google.maps.Geocoder();

            geocoder.geocode({ 'address': user_address }, (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });

            map.addListener("idle", () => {
                if (fetchTimeout) clearTimeout(fetchTimeout);
                fetchTimeout = setTimeout(fetchMapData, 500); // wait 0.5s after idle
            });

        }
        let user = "";

        function fetchMapData() {

            const bounds = map.getBounds();
            if (!bounds) {
                console.warn("Map bounds not available yet.");
                return;
            }

            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            const maxLat = ne.lat();
            const maxLng = ne.lng();
            const minLat = sw.lat();
            const minLng = sw.lng();
            console.log(`Map bounds: NE(${maxLat}, ${maxLng}), SW(${minLat}, ${minLng})`);

            // Fetch maps data asynchronously after map loads
            const url = `/maps/maps-data/${minLat}/${minLng}/${maxLat}/${maxLng}/`;
            fetch(url)
                .then(res => {
                    const userName = res.headers.get('X-User-Name');
                    console.log("fetched username from header:", userName);
                    user = userName;
                    return res.json();
                })
                .then(data => {
                    console.log("maps data received:", data);
                    addMarkers(data);

                    loadPeopleData();
                })
                .catch(err => console.error("Error fetching delivery data:", err));
        }


        function addMarkers(addressGroups) {

            // ensure we have bounds on the map
            const bounds = map.getBounds();

            if (!bounds) {
                console.warn("Map bounds not available yet.");
                return;
            }

            // Remove markers that are out of bounds
            for (const [address, marker] of Object.entries(markers)) {
                if (!bounds.contains(marker.getPosition())) {
                    marker.setMap(null);
                    delete markers[address];
                }
            }
            // Add a marker for each address
            addressGroups.forEach(group => {
                const address = group.address;

                // Skip missing or invalid addresses
                if (!address || address.trim().length < 5) {
                    console.warn("Skipping invalid address:", address);
                    return;
                }

                // Skip if marker already exists
                if (markers[address]) return;

                // Geocode the address to get its location and add marker
                geocoder.geocode({ 'address': address }, (results, status) => {
                    if (status === 'OK') {
                        const location = results[0].geometry.location;

                        const marker = new google.maps.Marker({
                            map: map,
                            position: location,
                            title: `Orders at ${address}`

                        });

                        marker.addListener('click', () => {
                            // Display user info in your popup
                            showPopup(group);

                            setTimeout(() => shop.click(), 100);
                        });

                        // store the user marker
                        markers[address] = marker;
                    } else {
                        console.error("Geocode failed:", status);
                    }
                });
            });
        }
        let popupJustOpened = false;


        function showPopup(group) {
            console.log("popup");
            let ordersHTML = group.orders.map(order => {
                const orderUser = order.user;
                console.log("order user:", orderUser);
                console.log("current user:", user);
                const isOwn = (orderUser === user);
                console.log("is own order?", isOwn);

                const buttonText = isOwn ? "Take own order" : "Accept Request";
                return `
                    <div class="border-t border-gray-300 mt-4 pt-4">
                        <p class="text-gray-700 text-xl"><b>Address:</b> ${group.address}</p>
                        <ul class="list-disc pl-6">
                            ${order.items.map(item => `
                                <li class="mb-1 border border-gray-300 rounded-lg p-2 mt-2">
                                    <span class="font-semibold">${item.name}</span>:
                                    <span class="font-semibold">${item.quantity} Ã— $${item.price} =</span>
                                    <span class="text-blue-700 font-bold">$${item.total.toFixed(2)}</span>
                                </li>
                            `).join('')}
                        </ul>
                        <p class="text-right text-lg font-bold mt-2">Subtotal: $${order.subtotal.toFixed(2)}</p>
                        <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2"
                                onclick="changeOrderStatus(${order.order_id}, 'inprogress')">
                            ${buttonText}
                        </button>
                    </div>
                `}).join('');

            const popup = document.getElementById('popup');
            console.log("popup element found?", popup);
            console.log("popup classes before:", popup?.classList.value);

            const userName = group.orders[0].user;
            const userId = group.orders[0].user_id;

            popup.classList.remove('translate-x-full');
            console.log("popup classes after:", popup.classList.value);
            // Inject into popup
            document.getElementById('popup-content').innerHTML = `
                <div class="space-y-4">
                    <a href="/profile/${userId}/" class="no-underline hover:underline">
                        <h2 class="text-4xl font-bold mb-2 text-center">${userName}</h2>
                    </a>
                    ${ordersHTML}
                </div>
            `;
            {% comment %} document.getElementById('popup').classList.remove('translate-x-full'); {% endcomment %}

            closePopup.addEventListener('click', () => {
                const popup = document.getElementById('popup');
                const map_popup = document.getElementById('map_popup');
                popup.classList.add('translate-x-full');
                map_popup.classList.remove('-translate-x-50');
            });

            {% comment %} document.addEventListener('click', (event) => {
                const popup = document.getElementById('popup');

                // if popup is currently visible
                if (!popup.classList.contains('translate-x-full')) {
                    // check if click was *outside* popup
                    if (!popup.contains(event.target)) {
                        popup.classList.add('translate-x-full');
                    }
                }
            }); {% endcomment %}
            console.log("end");
            popupJustOpened = true;
        }

        // global listener for outside clicks
        document.addEventListener("click", (event) => {
            const popup = document.getElementById("popup");
            if (!popup || popup.classList.contains("translate-x-full")) return;

            // Ignore the first click right after popup opens
            if (popupJustOpened) {
                popupJustOpened = false;
                return;
            }

            // If click was inside popup, ignore
            if (popup.contains(event.target)) return;

            // Otherwise, close popup
            popup.classList.add("translate-x-full");
        });

        function geocodeAddress() {
            const address = document.getElementById('input_location').value;
            geocoder.geocode({ 'address': address }, (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    map.setCenter(location);
                    document.getElementById('input_location').value = '';


                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        } 

        function loadPeopleData() {

            const bounds = map.getBounds();
            if (!bounds) {
                console.warn("Map bounds not available yet.");
                return;
            }

            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            const maxLat = ne.lat();
            const maxLng = ne.lng();
            const minLat = sw.lat();
            const minLng = sw.lng();
            console.log(`Map bounds: NE(${maxLat}, ${maxLng}), SW(${minLat}, ${minLng})`);

            // Fetch maps data asynchronously after map loads
            const url = `/maps/people-data/${minLat}/${minLng}/${maxLat}/${maxLng}/`;
            fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    console.log("People data received:", data);
                    const peopleDiv = document.getElementById('people');

                    // Example rendering of people data
                    peopleDiv.innerHTML = `
                        <div class="p-4 space-y-2">
                            <h3 class="text-2xl font-bold mb-4">Nearby People</h3>
                            ${data.people.map(person => `
                                <div class="border p-3 rounded-lg bg-gray-100">
                                    <a href="/profile/${person.user_id}/" class="no-underline hover:underline">
                                        <p class="font-semibold">${person.name}</p>
                                    </a>
                                    <p class="text-sm text-gray-600">${person.address}</p>
                                    <p class="text-sm text-gray-600">Order Price: $${person.order_data.subtotal}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                })
                .catch(error => {
                    console.error("Error loading people data:", error);
                    document.getElementById('people').innerHTML = "<p class='text-red-500 p-4'>Failed to load people data.</p>";
                });
            }

        function changeOrderStatus(orderId, newStatus) {
            fetch(`/change_order_status/${orderId}/${newStatus}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token for security
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Order status updated successfully!');
                    window.location.reload();
                    
                } else {
                    alert('Failed to update order status.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the order status.');
            });
        }

        {% comment %} window.addEventListener('load', initMap) {% endcomment %}
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap">

    </script>

</body>